<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:Converters="clr-namespace:XiaoZhiSharp_MauiApp.Converters"
             x:Class="XiaoZhiSharp_MauiApp.SettingsPage"
             Title="è®¾ç½®">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">
            
            <!-- é¡µé¢æ ‡é¢˜ -->
            <VerticalStackLayout Spacing="5">
                <Label Text="ðŸ”§ è¿žæŽ¥è®¾ç½®" FontSize="24" FontAttributes="Bold"/>
                <Label Text="é…ç½®å°æ™ºAIæœåŠ¡å™¨è¿žæŽ¥å‚æ•°" TextColor="Gray" FontSize="14"/>
            </VerticalStackLayout>

            <!-- æœåŠ¡å™¨URLè®¾ç½® -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="ðŸŒ" FontSize="24"/>
                        <VerticalStackLayout>
                            <Label Text="æœåŠ¡å™¨URL" FontAttributes="Bold"/>
                            <Label Text="WebSocketæœåŠ¡å™¨è¿žæŽ¥åœ°å€" FontSize="12" TextColor="Gray"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    <Entry Text="{Binding ServerUrl}" Placeholder="wss://api.tenclass.net/xiaozhi/v1/"/>
                </VerticalStackLayout>
            </Frame>

            <!-- MACåœ°å€è®¾ç½® -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="ðŸ·ï¸" FontSize="24"/>
                        <VerticalStackLayout>
                            <Label Text="MACåœ°å€" FontAttributes="Bold"/>
                            <Label Text="è®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦" FontSize="12" TextColor="Gray"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    <Entry Text="{Binding DeviceId}" Placeholder="06:FB:BE:44:2D:29"/>
                </VerticalStackLayout>
            </Frame>

            <!-- OTAåœ°å€è®¾ç½® -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="ðŸ”„" FontSize="24"/>
                        <VerticalStackLayout>
                            <Label Text="OTAåœ°å€" FontAttributes="Bold"/>
                            <Label Text="è®¾å¤‡æ›´æ–°å’Œé…ç½®æœåŠ¡å™¨åœ°å€" FontSize="12" TextColor="Gray"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    <Entry Text="{Binding OtaUrl}" Placeholder="https://api.tenclass.net/xiaozhi/ota/"/>
                </VerticalStackLayout>
            </Frame>

            <!-- OTAçŠ¶æ€ä¿¡æ¯ -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="ðŸ“Š" FontSize="24"/>
                        <VerticalStackLayout>
                            <Label Text="OTAçŠ¶æ€ä¿¡æ¯" FontAttributes="Bold"/>
                            <Label Text="è®¾å¤‡è¿žæŽ¥å’Œé…ç½®çŠ¶æ€" FontSize="12" TextColor="Gray"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    
                    <BoxView HeightRequest="1" BackgroundColor="#e0e0e0" Margin="0,5"/>
                    
                    <!-- çŠ¶æ€ä¿¡æ¯åˆ—è¡¨ -->
                    <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto" ColumnDefinitions="Auto,*" RowSpacing="8">
                        <Label Grid.Row="0" Grid.Column="0" Text="è¿žæŽ¥çŠ¶æ€:" FontAttributes="Bold"/>
                        <Label Grid.Row="0" Grid.Column="1" 
                               TextColor="{Binding IsConnected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#51cf66;#ff6b6b'}">
                            <Label.Text>
                                <MultiBinding StringFormat="{}{0}">
                                    <Binding Path="IsConnected" Converter="{StaticResource BoolToStringConverter}" ConverterParameter="âœ… å·²è¿žæŽ¥;âŒ æœªè¿žæŽ¥"/>
                                </MultiBinding>
                            </Label.Text>
                        </Label>
                        
                        <Label Grid.Row="1" Grid.Column="0" Text="OTAçŠ¶æ€:" FontAttributes="Bold"/>
                        <Label Grid.Row="1" Grid.Column="1" Text="{Binding OtaStatus}"/>
                        
                        <Label Grid.Row="2" Grid.Column="0" Text="å½“å‰ç‰ˆæœ¬:" FontAttributes="Bold"/>
                        <Label Grid.Row="2" Grid.Column="1" Text="{Binding CurrentVersion}"/>
                        
                        <Label Grid.Row="3" Grid.Column="0" Text="æœ€æ–°ç‰ˆæœ¬:" FontAttributes="Bold" 
                               IsVisible="{Binding LatestVersion, Converter={StaticResource StringToBoolConverter}}"/>
                        <Label Grid.Row="3" Grid.Column="1" Text="{Binding LatestVersion}" 
                               IsVisible="{Binding LatestVersion, Converter={StaticResource StringToBoolConverter}}"/>
                        
                        <!-- éªŒè¯çŠ¶æ€ -->
                        <Label Grid.Row="4" Grid.Column="0" Text="éªŒè¯çŠ¶æ€:" FontAttributes="Bold"/>
                        <HorizontalStackLayout Grid.Row="4" Grid.Column="1" Spacing="10">
                            <Label Text="{Binding ActivationStatus}" FontAttributes="Bold"
                                   TextColor="{Binding IsActivated, Converter={StaticResource BoolToColorConverter}, ConverterParameter='#51cf66;#ff9500'}"/>
                            <Label Text="{Binding ActivationCode, StringFormat='(éªŒè¯ç : {0})'}" 
                                   IsVisible="{Binding ShowActivationCode}"
                                   TextColor="#339af0" FontAttributes="Bold"/>
                        </HorizontalStackLayout>
                        
                        <Label Grid.Row="5" Grid.Column="0" Text="æ¿€æ´»æ¶ˆæ¯:" FontAttributes="Bold" 
                               IsVisible="{Binding ActivationMessage, Converter={StaticResource StringToBoolConverter}}"/>
                        <Label Grid.Row="5" Grid.Column="1" Text="{Binding ActivationMessage}" FontSize="12"
                               IsVisible="{Binding ActivationMessage, Converter={StaticResource StringToBoolConverter}}"/>
                        
                        <Label Grid.Row="6" Grid.Column="0" Text="æœ€åŽæ£€æŸ¥:" FontAttributes="Bold" 
                               IsVisible="{Binding LastOtaCheckTime, Converter={StaticResource NullToBoolConverter}}"/>
                        <Label Grid.Row="6" Grid.Column="1" Text="{Binding LastOtaCheckTime, StringFormat='{0:yyyy-MM-dd HH:mm:ss}'}" 
                               IsVisible="{Binding LastOtaCheckTime, Converter={StaticResource NullToBoolConverter}}"/>
                    </Grid>
                    
                    <Button Text="ðŸ”„ æ‰‹åŠ¨æ£€æŸ¥OTA" BackgroundColor="#339af0" TextColor="White" 
                            Clicked="OnManualOtaCheckClicked" Margin="0,10,0,0"/>
                </VerticalStackLayout>
            </Frame>

            <!-- VADé˜ˆå€¼è®¾ç½® -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="ðŸŽ™ï¸" FontSize="24"/>
                        <VerticalStackLayout>
                            <Label Text="VADé˜ˆå€¼" FontAttributes="Bold"/>
                            <Label Text="è¯­éŸ³æ´»åŠ¨æ£€æµ‹é˜ˆå€¼ (æ¯«ç§’)" FontSize="12" TextColor="Gray"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    <Entry Text="{Binding VadThreshold}" Keyboard="Numeric" Placeholder="40"/>
                </VerticalStackLayout>
            </Frame>

            <!-- é«˜çº§VADè®¾ç½® -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                <VerticalStackLayout Spacing="15">
                    <HorizontalStackLayout Spacing="10">
                        <Label Text="ðŸŽ›ï¸" FontSize="24"/>
                        <VerticalStackLayout>
                            <Label Text="é«˜çº§VADè®¾ç½®" FontAttributes="Bold"/>
                            <Label Text="è‡ªé€‚åº”è¯­éŸ³æ£€æµ‹å‚æ•°" FontSize="12" TextColor="Gray"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    
                    <BoxView HeightRequest="1" BackgroundColor="#e0e0e0" Margin="0,5"/>
                    
                    <!-- å¯ç”¨VADå¼€å…³ -->
                    <Grid ColumnDefinitions="*,Auto">
                        <HorizontalStackLayout Grid.Column="0" Spacing="10">
                            <Label Text="å¯ç”¨æ™ºèƒ½VAD" VerticalOptions="Center" FontSize="14"/>
                            <Label Text="(è‡ªé€‚åº”å™ªéŸ³æ£€æµ‹)" FontSize="12" TextColor="Gray" VerticalOptions="Center"/>
                        </HorizontalStackLayout>
                        <Switch Grid.Column="1" IsToggled="{Binding UseVAD}" VerticalOptions="Center"/>
                    </Grid>
                    
                    <!-- èƒ½é‡é˜ˆå€¼ -->
                    <VerticalStackLayout Spacing="5" IsVisible="{Binding UseVAD}">
                        <Label Text="{Binding VadEnergyThreshold, StringFormat='èƒ½é‡é˜ˆå€¼: {0:F3}'}" FontSize="14"/>
                        <Slider Minimum="0.005" Maximum="0.05" Value="{Binding VadEnergyThreshold}"/>
                        <Label Text="è¾ƒä½Žå€¼åœ¨å®‰é™çŽ¯å¢ƒä¸‹æ›´çµæ•ï¼Œè¾ƒé«˜å€¼é€‚åˆå˜ˆæ‚çŽ¯å¢ƒ" FontSize="11" TextColor="Gray"/>
                    </VerticalStackLayout>
                    
                    <!-- é™éŸ³å¸§æ•° -->
                    <VerticalStackLayout Spacing="5" IsVisible="{Binding UseVAD}">
                        <Label Text="{Binding VadSilenceFrames, StringFormat='é™éŸ³å¸§æ•°: {0}'}" FontSize="14"/>
                        <Slider Minimum="10" Maximum="50" Value="{Binding VadSilenceFrames}"/>
                        <Label Text="æ£€æµ‹åˆ°å¤šå°‘é™éŸ³å¸§åŽç»“æŸå½•éŸ³ï¼ˆæ¯å¸§60msï¼‰" FontSize="11" TextColor="Gray"/>
                    </VerticalStackLayout>
                    
                    <!-- TTSå†·å´æ—¶é—´ -->
                    <VerticalStackLayout Spacing="5" IsVisible="{Binding UseVAD}">
                        <Label Text="{Binding TtsCooldownTime, StringFormat='TTSå†·å´æ—¶é—´: {0:F1}ç§’'}" FontSize="14"/>
                        <Slider Minimum="0.3" Maximum="2.0" Value="{Binding TtsCooldownTime}"/>
                        <Label Text="æ’­æ”¾ç»“æŸåŽçš„å†·å´æ—¶é—´ï¼Œé¿å…å›žéŸ³å¹²æ‰°" FontSize="11" TextColor="Gray"/>
                    </VerticalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- è°ƒè¯•æ¨¡å¼è®¾ç½® -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True">
                <Grid ColumnDefinitions="*,Auto">
                    <HorizontalStackLayout Grid.Column="0" Spacing="10">
                        <Label Text="ðŸ›" FontSize="24"/>
                        <VerticalStackLayout>
                            <Label Text="è°ƒè¯•æ¨¡å¼" FontAttributes="Bold"/>
                            <Label Text="å¯ç”¨è°ƒè¯•æ—¥å¿—è¾“å‡º" FontSize="12" TextColor="Gray"/>
                        </VerticalStackLayout>
                    </HorizontalStackLayout>
                    <Switch Grid.Column="1" IsToggled="{Binding IsDebugMode}" VerticalOptions="Center"/>
                </Grid>
            </Frame>

            <!-- è°ƒè¯•æ—¥å¿—æ˜¾ç¤º -->
            <Frame BackgroundColor="White" Padding="15" CornerRadius="10" HasShadow="True" 
                   IsVisible="{Binding IsDebugMode}">
                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="*,Auto">
                        <HorizontalStackLayout Grid.Column="0" Spacing="10">
                            <Label Text="ðŸ“‹" FontSize="24"/>
                            <VerticalStackLayout>
                                <Label Text="è°ƒè¯•æ—¥å¿—" FontAttributes="Bold"/>
                                <Label Text="{Binding DebugLogs.Count, StringFormat='å…± {0} æ¡æ—¥å¿—'}" FontSize="12" TextColor="Gray"/>
                            </VerticalStackLayout>
                        </HorizontalStackLayout>
                        <Button Grid.Column="1" Text="ðŸ—‘ï¸ æ¸…ç©º" BackgroundColor="Transparent" 
                                TextColor="#ff6b6b" Clicked="OnClearLogsClicked"/>
                    </Grid>
                    
                    <ScrollView HeightRequest="200" BackgroundColor="#f5f5f5">
                        <CollectionView x:Name="DebugLogsCollectionView">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame BackgroundColor="White" Padding="8,4" Margin="5,2" BorderColor="Transparent" CornerRadius="4">
                                        <Label Text="{Binding}" FontSize="12" LineBreakMode="WordWrap" TextColor="#333333"/>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </ScrollView>
                </VerticalStackLayout>
            </Frame>

            <!-- æ“ä½œæŒ‰é’® -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10" Margin="0,10">
                <Button Grid.Column="0" Text="ðŸ’¾ ä¿å­˜è®¾ç½®" BackgroundColor="#51cf66" TextColor="White" 
                        Clicked="OnSaveSettingsClicked"/>
                <Button Grid.Column="1" Text="ðŸ”„ åº”ç”¨å¹¶é‡è¿ž" BackgroundColor="#339af0" TextColor="White" 
                        Clicked="OnApplySettingsClicked"/>
                <Button Grid.Column="2" Text="ðŸ”„ æ¢å¤é»˜è®¤" BackgroundColor="#ff6b6b" TextColor="White" 
                        Clicked="OnResetSettingsClicked"/>
            </Grid>

        </VerticalStackLayout>
    </ScrollView>

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- è½¬æ¢å™¨ -->
            <Converters:BoolToStringConverter x:Key="BoolToStringConverter"/>
            <Converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
            <Converters:StringToBoolConverter x:Key="StringToBoolConverter"/>
            <Converters:NullToBoolConverter x:Key="NullToBoolConverter"/>
            <Converters:IntToSecondsConverter x:Key="IntToSecondsConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>
</ContentPage> 