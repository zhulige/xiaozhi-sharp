@page "/settings"
@inject XiaoZhi_AgentService XiaoZhiAgent

<div class="settings-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="settings-header">
        <h2>ğŸ”§ è¿æ¥è®¾ç½®</h2>
        <p class="settings-subtitle">é…ç½®å°æ™ºAIæœåŠ¡å™¨è¿æ¥å‚æ•°</p>
    </div>

    <!-- è®¾ç½®é¡¹åˆ—è¡¨ -->
    <div class="settings-content">
        <!-- æœåŠ¡å™¨URLè®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸŒ</div>
                <div class="setting-info">
                    <h3>æœåŠ¡å™¨URL</h3>
                    <p>WebSocketæœåŠ¡å™¨è¿æ¥åœ°å€</p>
                </div>
            </div>
            <div class="setting-input">
                <input type="text" class="input-field" @bind="XiaoZhiAgent.ServerUrl" 
                       placeholder="wss://api.tenclass.net/xiaozhi/v1/" />
            </div>
        </div>

        <!-- MACåœ°å€è®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ·ï¸</div>
                <div class="setting-info">
                    <h3>MACåœ°å€</h3>
                    <p>è®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦</p>
                </div>
            </div>
            <div class="setting-input">
                <input type="text" class="input-field" @bind="XiaoZhiAgent.DeviceId" 
                       placeholder="06:FB:BE:44:2D:29" />
            </div>
        </div>

        <!-- OTAåœ°å€è®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ”„</div>
                <div class="setting-info">
                    <h3>OTAåœ°å€</h3>
                    <p>è®¾å¤‡æ›´æ–°å’Œé…ç½®æœåŠ¡å™¨åœ°å€</p>
                </div>
            </div>
            <div class="setting-input">
                <input type="text" class="input-field" @bind="XiaoZhiAgent.OtaUrl" 
                       placeholder="https://api.tenclass.net/xiaozhi/ota/" />
            </div>
        </div>

        <!-- VADé˜ˆå€¼è®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ™ï¸</div>
                <div class="setting-info">
                    <h3>VADé˜ˆå€¼</h3>
                    <p>è¯­éŸ³æ´»åŠ¨æ£€æµ‹é˜ˆå€¼ (æ¯«ç§’)</p>
                </div>
            </div>
            <div class="setting-input">
                <input type="number" class="input-field" @bind="XiaoZhiAgent.VadThreshold" 
                       min="10" max="100" placeholder="40" />
            </div>
        </div>

        <!-- è°ƒè¯•æ¨¡å¼è®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ›</div>
                <div class="setting-info">
                    <h3>è°ƒè¯•æ¨¡å¼</h3>
                    <p>å¯ç”¨è°ƒè¯•æ—¥å¿—è¾“å‡º</p>
                </div>
            </div>
            <div class="setting-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" @bind="XiaoZhiAgent.IsDebugMode" />
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="settings-actions">
        <button class="settings-action-button save" @onclick="SaveSettings" disabled="@isSaving">
            @if (isSaving)
            {
                <span class="loading-spinner"></span>
                <span>ä¿å­˜ä¸­...</span>
            }
            else
            {
                <span>ğŸ’¾ ä¿å­˜è®¾ç½®</span>
            }
        </button>
        
        <button class="settings-action-button apply" @onclick="ApplySettings" disabled="@isApplying">
            @if (isApplying)
            {
                <span class="loading-spinner"></span>
                <span>åº”ç”¨ä¸­...</span>
            }
            else
            {
                <span>ğŸ”„ åº”ç”¨å¹¶é‡è¿</span>
            }
        </button>
        
        <button class="settings-action-button reset" @onclick="ResetSettings">
            ğŸ”„ æ¢å¤é»˜è®¤
        </button>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message @statusType">
            @statusMessage
        </div>
    }
</div>

@code {
    private bool isSaving = false;
    private bool isApplying = false;
    private string statusMessage = "";
    private string statusType = "";

    private async Task SaveSettings()
    {
        isSaving = true;
        statusMessage = "";
        
        try
        {
            XiaoZhiAgent.SaveSettings();
            statusMessage = "è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼";
            statusType = "success";
            
            // 3ç§’åæ¸…é™¤æ¶ˆæ¯
            await Task.Delay(3000);
            statusMessage = "";
        }
        catch (Exception ex)
        {
            statusMessage = $"ä¿å­˜å¤±è´¥: {ex.Message}";
            statusType = "error";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ApplySettings()
    {
        isApplying = true;
        statusMessage = "";
        
        try
        {
            await XiaoZhiAgent.ApplySettings();
            statusMessage = "è®¾ç½®å·²åº”ç”¨ï¼Œè¿æ¥å·²é‡æ–°å»ºç«‹ï¼";
            statusType = "success";
            
            // 3ç§’åæ¸…é™¤æ¶ˆæ¯
            await Task.Delay(3000);
            statusMessage = "";
        }
        catch (Exception ex)
        {
            statusMessage = $"åº”ç”¨å¤±è´¥: {ex.Message}";
            statusType = "error";
        }
        finally
        {
            isApplying = false;
        }
    }

    private async Task ResetSettings()
    {
        XiaoZhiAgent.ResetSettings();
        
        statusMessage = "è®¾ç½®å·²æ¢å¤ä¸ºé»˜è®¤å€¼";
        statusType = "info";
        
        StateHasChanged();
        
        // 3ç§’åæ¸…é™¤æ¶ˆæ¯
        await Task.Delay(3000);
        statusMessage = "";
        StateHasChanged();
    }
} 