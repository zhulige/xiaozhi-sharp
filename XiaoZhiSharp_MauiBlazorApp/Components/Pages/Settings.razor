@page "/settings"
@inject XiaoZhi_AgentService XiaoZhiAgent
@implements IDisposable

<div class="settings-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="settings-header">
        <h2>ğŸ”§ è¿æ¥è®¾ç½®</h2>
        <p class="settings-subtitle">é…ç½®å°æ™ºAIæœåŠ¡å™¨è¿æ¥å‚æ•°</p>
    </div>

    <!-- è®¾ç½®é¡¹åˆ—è¡¨ -->
    <div class="settings-content">
        <!-- æœåŠ¡å™¨URLè®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸŒ</div>
                <div class="setting-info">
                    <h3>æœåŠ¡å™¨URL</h3>
                    <p>WebSocketæœåŠ¡å™¨è¿æ¥åœ°å€</p>
                </div>
            </div>
            <div class="setting-input">
                <input type="text" class="input-field" @bind="XiaoZhiAgent.ServerUrl" 
                       placeholder="wss://api.tenclass.net/xiaozhi/v1/" />
            </div>
        </div>

        <!-- MACåœ°å€è®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ·ï¸</div>
                <div class="setting-info">
                    <h3>MACåœ°å€</h3>
                    <p>è®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦</p>
                </div>
            </div>
            <div class="setting-input">
                <input type="text" class="input-field" @bind="XiaoZhiAgent.DeviceId" 
                       placeholder="06:FB:BE:44:2D:29" />
            </div>
        </div>

        <!-- OTAåœ°å€è®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ”„</div>
                <div class="setting-info">
                    <h3>OTAåœ°å€</h3>
                    <p>è®¾å¤‡æ›´æ–°å’Œé…ç½®æœåŠ¡å™¨åœ°å€</p>
                </div>
            </div>
            <div class="setting-input">
                <input type="text" class="input-field" @bind="XiaoZhiAgent.OtaUrl" 
                       placeholder="https://api.tenclass.net/xiaozhi/ota/" />
            </div>
        </div>

        <!-- OTAçŠ¶æ€ä¿¡æ¯ -->
        <div class="setting-group ota-status-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ“Š</div>
                <div class="setting-info">
                    <h3>OTAçŠ¶æ€ä¿¡æ¯</h3>
                    <p>è®¾å¤‡è¿æ¥å’Œé…ç½®çŠ¶æ€</p>
                </div>
            </div>
            <div class="ota-status-content">
                <div class="status-row">
                    <span class="status-label">è¿æ¥çŠ¶æ€:</span>
                    <span class="status-value @(XiaoZhiAgent.IsConnected ? "connected" : "disconnected")">
                        @(XiaoZhiAgent.IsConnected ? "âœ… å·²è¿æ¥" : "âŒ æœªè¿æ¥")
                    </span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">OTAçŠ¶æ€:</span>
                    <span class="status-value">@XiaoZhiAgent.OtaStatus</span>
                </div>

                @if (XiaoZhiAgent.LastOtaCheckTime.HasValue)
                {
                    <div class="status-row">
                        <span class="status-label">æœ€åæ£€æŸ¥:</span>
                        <span class="status-value">@XiaoZhiAgent.LastOtaCheckTime?.ToString("yyyy-MM-dd HH:mm:ss")</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(XiaoZhiAgent.ActivationCode))
                {
                    <div class="status-row">
                        <span class="status-label">æ¿€æ´»ç :</span>
                        <span class="status-value activation-code">@XiaoZhiAgent.ActivationCode</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(XiaoZhiAgent.ActivationMessage))
                {
                    <div class="status-row">
                        <span class="status-label">æ¿€æ´»æ¶ˆæ¯:</span>
                        <span class="status-value">@XiaoZhiAgent.ActivationMessage</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(XiaoZhiAgent.FirmwareVersion))
                {
                    <div class="status-row">
                        <span class="status-label">å›ºä»¶ç‰ˆæœ¬:</span>
                        <span class="status-value">@XiaoZhiAgent.FirmwareVersion</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(XiaoZhiAgent.FirmwareUrl))
                {
                    <div class="status-row">
                        <span class="status-label">å›ºä»¶ä¸‹è½½:</span>
                        <span class="status-value firmware-url">ğŸ”— æœ‰æ›´æ–°å¯ç”¨</span>
                    </div>
                }

                @if (XiaoZhiAgent.ServerTime.HasValue)
                {
                    <div class="status-row">
                        <span class="status-label">æœåŠ¡å™¨æ—¶é—´:</span>
                        <span class="status-value">@XiaoZhiAgent.ServerTime?.ToString("yyyy-MM-dd HH:mm:ss")</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(XiaoZhiAgent.MqttEndpoint))
                {
                    <div class="status-row">
                        <span class="status-label">MQTTæœåŠ¡å™¨:</span>
                        <span class="status-value">@XiaoZhiAgent.MqttEndpoint</span>
                    </div>
                }

                <div class="ota-actions">
                    <button class="ota-check-button" @onclick="ManualOtaCheck">
                        ğŸ”„ æ‰‹åŠ¨æ£€æŸ¥OTA
                    </button>
                </div>
            </div>
        </div>

        <!-- VADé˜ˆå€¼è®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ™ï¸</div>
                <div class="setting-info">
                    <h3>VADé˜ˆå€¼</h3>
                    <p>è¯­éŸ³æ´»åŠ¨æ£€æµ‹é˜ˆå€¼ (æ¯«ç§’)</p>
                </div>
            </div>
            <div class="setting-input">
                <input type="number" class="input-field" @bind="XiaoZhiAgent.VadThreshold" 
                       min="10" max="100" placeholder="40" />
            </div>
        </div>

        <!-- è°ƒè¯•æ¨¡å¼è®¾ç½® -->
        <div class="setting-group">
            <div class="setting-header">
                <div class="setting-icon">ğŸ›</div>
                <div class="setting-info">
                    <h3>è°ƒè¯•æ¨¡å¼</h3>
                    <p>å¯ç”¨è°ƒè¯•æ—¥å¿—è¾“å‡º</p>
                </div>
            </div>
            <div class="setting-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" @bind="XiaoZhiAgent.IsDebugMode" />
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- è°ƒè¯•æ—¥å¿—æ˜¾ç¤º -->
        @if (XiaoZhiAgent.IsDebugMode)
        {
            <div class="setting-group debug-logs-group">
                <div class="setting-header">
                    <div class="setting-icon">ğŸ“‹</div>
                    <div class="setting-info">
                        <h3>è°ƒè¯•æ—¥å¿—</h3>
                        <p>å®æ—¶æ¶ˆæ¯å’ŒOTAçŠ¶æ€æ—¥å¿—</p>
                    </div>
                </div>
                <div class="debug-logs-content">
                    <div class="logs-header">
                        <span class="logs-count">å…± @XiaoZhiAgent.DebugLogs.Count æ¡æ—¥å¿—</span>
                        <button class="clear-logs-button" @onclick="ClearLogs">
                            ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                        </button>
                    </div>
                    <div class="logs-container">
                        @if (XiaoZhiAgent.DebugLogs.Count == 0)
                        {
                            <div class="no-logs">æš‚æ— æ—¥å¿—ä¿¡æ¯</div>
                        }
                        else
                        {
                            @foreach (var log in XiaoZhiAgent.DebugLogs.Reverse())
                            {
                                <div class="log-entry">@log</div>
                            }
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="settings-actions">
        <button class="settings-action-button save" @onclick="SaveSettings" disabled="@isSaving">
            @if (isSaving)
            {
                <span class="loading-spinner"></span>
                <span>ä¿å­˜ä¸­...</span>
            }
            else
            {
                <span>ğŸ’¾ ä¿å­˜è®¾ç½®</span>
            }
        </button>
        
        <button class="settings-action-button apply" @onclick="ApplySettings" disabled="@isApplying">
            @if (isApplying)
            {
                <span class="loading-spinner"></span>
                <span>åº”ç”¨ä¸­...</span>
            }
            else
            {
                <span>ğŸ”„ åº”ç”¨å¹¶é‡è¿</span>
            }
        </button>
        
        <button class="settings-action-button reset" @onclick="ResetSettings">
            ğŸ”„ æ¢å¤é»˜è®¤
        </button>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message @statusType">
            @statusMessage
        </div>
    }
</div>

@code {
    private bool isSaving = false;
    private bool isApplying = false;
    private string statusMessage = "";
    private string statusType = "";
    private Timer? refreshTimer;

    protected override void OnInitialized()
    {
        // å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯ç§’åˆ·æ–°ä¸€æ¬¡ç•Œé¢ï¼ˆä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼‰
        refreshTimer = new Timer(async _ =>
        {
            if (XiaoZhiAgent.IsDebugMode)
            {
                await InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    public void Dispose()
    {
        refreshTimer?.Dispose();
    }

    private async Task SaveSettings()
    {
        isSaving = true;
        statusMessage = "";
        
        try
        {
            XiaoZhiAgent.SaveSettings();
            statusMessage = "è®¾ç½®å·²ä¿å­˜æˆåŠŸï¼";
            statusType = "success";
            
            // 3ç§’åæ¸…é™¤æ¶ˆæ¯
            await Task.Delay(3000);
            statusMessage = "";
        }
        catch (Exception ex)
        {
            statusMessage = $"ä¿å­˜å¤±è´¥: {ex.Message}";
            statusType = "error";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task ApplySettings()
    {
        isApplying = true;
        statusMessage = "";
        
        try
        {
            await XiaoZhiAgent.ApplySettings();
            statusMessage = "è®¾ç½®å·²åº”ç”¨ï¼Œè¿æ¥å·²é‡æ–°å»ºç«‹ï¼";
            statusType = "success";
            
            // 3ç§’åæ¸…é™¤æ¶ˆæ¯
            await Task.Delay(3000);
            statusMessage = "";
        }
        catch (Exception ex)
        {
            statusMessage = $"åº”ç”¨å¤±è´¥: {ex.Message}";
            statusType = "error";
        }
        finally
        {
            isApplying = false;
        }
    }

    private async Task ResetSettings()
    {
        XiaoZhiAgent.ResetSettings();
        
        statusMessage = "è®¾ç½®å·²æ¢å¤ä¸ºé»˜è®¤å€¼";
        statusType = "info";
        
        StateHasChanged();
        
        // 3ç§’åæ¸…é™¤æ¶ˆæ¯
        await Task.Delay(3000);
        statusMessage = "";
        StateHasChanged();
    }

    private async Task ManualOtaCheck()
    {
        statusMessage = "æ­£åœ¨è¿›è¡ŒOTAæ£€æŸ¥...";
        statusType = "info";
        StateHasChanged();
        
        try
        {
            await XiaoZhiAgent.ManualOtaCheck();
            statusMessage = "OTAæ£€æŸ¥å®Œæˆ";
            statusType = "success";
        }
        catch (Exception ex)
        {
            statusMessage = $"OTAæ£€æŸ¥å¤±è´¥: {ex.Message}";
            statusType = "error";
        }
        
        StateHasChanged();
        
        // 3ç§’åæ¸…é™¤æ¶ˆæ¯
        await Task.Delay(3000);
        statusMessage = "";
        StateHasChanged();
    }

    private void ClearLogs()
    {
        XiaoZhiAgent.ClearDebugLogs();
        statusMessage = "è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º";
        statusType = "info";
        StateHasChanged();
        
        // 3ç§’åæ¸…é™¤æ¶ˆæ¯
        _ = Task.Run(async () =>
        {
            await Task.Delay(3000);
            statusMessage = "";
            await InvokeAsync(StateHasChanged);
        });
    }
} 